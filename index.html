<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Writing Prompt Widget</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      padding: 20px;
      text-align: center;
    }
    #widget {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 { color: #333; }
    #prompt { font-size: 1.2em; margin: 20px 0; }
    .hidden { display: none; }
    input, button, textarea {
      margin: 5px;
      padding: 8px;
    }
    #teacher-panel {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="widget">
    <h2>Daily Writing Prompt</h2>
    <div id="prompt">Loading...</div>
    
    <!-- Teacher login -->
    <div id="login">
      <input type="password" id="password" placeholder="Teacher Password">
      <button onclick="login()">Log In</button>
    </div>

    <!-- Teacher panel -->
    <div id="teacher-panel" class="hidden">
      <h3>Teacher Controls</h3>
      <textarea id="editPrompt" rows="3" cols="40"></textarea><br>
      <button onclick="updatePrompt()">Update Prompt</button>
      <button onclick="logout()">Log Out</button>
    </div>
  </div>

  <script>
    // Google Sheet (published CSV of prompts)
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyn4gIZw-c9F5fNQdPAgF9Diwspr6Ly3gndfpkyGZw5mGFct5lN8Vuv4ltKhfmZUA3CkY2vh24gNXB/pub?gid=0&single=true&output=csv";

    // Base no-school dates
    const noSchoolDates = [
      // 2025
      "2025-09-23","2025-09-24", // Rosh Hashanah
      "2025-10-02",              // Yom Kippur
      "2025-10-13",              // Italian Heritage / Indigenous Peoples' Day
      "2025-10-20",              // Diwali
      "2025-11-04",              // Election Day
      "2025-11-11",              // Veterans Day
      "2025-11-27","2025-11-28", // Thanksgiving Recess

      // 2026
      "2026-01-19",              // MLK Jr. Day
      "2026-03-20",              // Eid al-Fitr
      "2026-05-25",              // Memorial Day
      "2026-05-27",              // Eid al-Adha
      "2026-06-04",              // Anniversary Day
      "2026-06-05",              // Clerical Day
      "2026-06-19"               // Juneteenth
    ];

    // Add extended recesses (helper function)
    function addRange(start, end) {
      const dates = [];
      let d = new Date(start);
      while (d <= new Date(end)) {
        dates.push(d.toISOString().split("T")[0]);
        d.setDate(d.getDate() + 1);
      }
      return dates;
    }

    noSchoolDates.push(
      ...addRange("2025-12-24", "2026-01-02"), // Winter Recess
      ...addRange("2026-02-16", "2026-02-20"), // Midwinter Recess
      ...addRange("2026-04-02", "2026-04-10")  // Spring Recess
    );

    let prompts = [];
    let todayPrompt = "";

    // Load prompts
    async function loadPrompts() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      prompts = text.split("\n").map(p => p.trim()).filter(p => p);

      selectPrompt();
    }

    // Select today's prompt (skip no-school days and weekends)
    function selectPrompt() {
      const today = new Date();
      const todayStr = today.toISOString().split("T")[0];

      // If today is a no-school date
      if (noSchoolDates.includes(todayStr)) {
        todayPrompt = "No School Today";
      } else {
        // Count how many school days have passed since the first day of school
        const start = new Date("2025-09-04"); // First day of NYC school year
        let count = 0;
        for (let d = new Date(start); d <= today; d.setDate(d.getDate() + 1)) {
          const dStr = d.toISOString().split("T")[0];
          const isWeekend = (d.getDay() === 0 || d.getDay() === 6);
          if (!isWeekend && !noSchoolDates.includes(dStr)) {
            count++;
          }
        }
        todayPrompt = prompts[(count - 1) % prompts.length];
      }

      document.getElementById("prompt").innerText = todayPrompt;
    }

    // Teacher Login
    document.getElementById("teacherToggle").addEventListener("click", () => {
      const panel = document.getElementById("teacherPanel");
      panel.style.display = panel.style.display === "block" ? "none" : "block";
    });

    document.getElementById("teacherLogin").addEventListener("click", () => {
      const pw = document.getElementById("teacherPassword").value;
      if (pw === "Mone270") {
        document.getElementById("teacherControls").style.display = "block";
        document.getElementById("teacherPassword").style.display = "none";
        document.getElementById("teacherLogin").style.display = "none";
      } else {
        alert("Incorrect password");
      }
    });

    document.getElementById("applyPrompt").addEventListener("click", () => {
      const newPrompt = document.getElementById("manualPrompt").value.trim();
      const msg = document.getElementById("teacherMsg");
      if (newPrompt) {
        localStorage.setItem("teacherOverridePrompt", newPrompt);
        document.getElementById("promptText").textContent = newPrompt;
        msg.textContent = "âœ… Custom prompt applied for today.";
      } else {
        localStorage.removeItem("teacherOverridePrompt");
        msg.textContent = "ðŸ§¹ Custom prompt cleared.";
        loadPrompt();
    }

    loadPrompts();
  </script>
</body>
</html>
